<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirecci√≥n WhatsApp</title>

  <meta name="robots" content="noindex, nofollow" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }
    .loading {
      text-align: center;
      font-size: 14px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="loading">Redirigiendo a un canal activo de WhatsApp...</div>

  <script>
    /********************************************
     * REDIRECTOR DE WHATSAPP ACTIVO
     * Obtiene n√∫meros desde tu API y redirige a uno aleatorio.
     ********************************************/
    const SERVICE_URL = "/api/get-random-phone";  // Tu endpoint Vercel
    const FALLBACK = [{ phone: "+5491169789243", weight: 1 }];
    const TTL_MS = 5 * 60 * 1000;
    const LS_KEY = `active_whatsapp_numbers_by_agency:1`;

    function fetchWithTimeout(url, opt = {}, ms = 2500) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
      return fetch(url, { ...opt, signal: ctrl.signal }).finally(() => clearTimeout(id));
    }

    function getCache() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); }
      catch { return null; }
    }

    function setCache(numbers) {
      localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), numbers }));
    }

    function parseApiPayload(data) {
      if (data && typeof data === "object" && (typeof data.phone_number === "string" || typeof data.phone_number === "number")) {
        return [{ phone: String(data.phone_number), weight: 1 }];
      }
      if (typeof data === "string") return [{ phone: data, weight: 1 }];
      const arr =
        (Array.isArray(data?.numbers) && data.numbers) ||
        (Array.isArray(data?.phone_numbers) && data.phone_numbers) ||
        (Array.isArray(data) && data) || [];
      return arr.map(item => {
        if (typeof item === "string") return { phone: item, weight: 1 };
        const phone = String(item?.phone ?? item?.phone_number ?? "").trim();
        const w = Number(item?.weight ?? 1);
        return { phone, weight: isFinite(w) && w > 0 ? w : 1 };
      });
    }

    function normalizeNumbers(list) {
      return (Array.isArray(list) ? list : [])
        .map(n => ({ phone: String(n.phone || "").trim(), weight: Number(n.weight || 1) }))
        .filter(n => /^\+?\d{8,17}$/.test(n.phone) && n.weight > 0);
    }

    async function loadNumbersOnce() {
      const cached = getCache();
      try {
        const res = await fetchWithTimeout(SERVICE_URL, { headers: { "Cache-Control": "no-store" } }, 2500);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const parsed = parseApiPayload(data);
        const clean = normalizeNumbers(parsed);
        if (clean.length) { setCache(clean); return clean; }
        throw new Error("Invalid payload");
      } catch (e) {
        const ok = cached?.numbers?.length && Date.now() - (cached.ts || 0) < TTL_MS;
        return ok ? cached.numbers : normalizeNumbers(FALLBACK);
      }
    }

    function pickWeightedRandom(list) {
      const total = list.reduce((s, it) => s + (Number(it.weight) || 1), 0);
      let r = Math.random() * total;
      for (const it of list) { r -= (Number(it.weight) || 1); if (r <= 0) return it; }
      return list[list.length - 1];
    }

    function buildWaUrl(phone, text = "") {
      const msg = text ? encodeURIComponent(text) : "";
      const cleanPhone = phone.replace(/\D/g, "");
      return `https://api.whatsapp.com/send?phone=${cleanPhone}${msg ? `&text=${msg}` : ""}`;
    }

    async function redirectToWhatsApp() {
      const list = await loadNumbersOnce();
      if (!list.length) {
        document.querySelector(".loading").textContent = "Error: no hay n√∫meros activos.";
        return;
      }
      const chosen = pickWeightedRandom(list);
      const mensaje = "¬°Hola! Me pas√°s mi usuario üöÄ";
      const waUrl = buildWaUrl(chosen.phone, mensaje);
      window.location.replace(waUrl);
    }

    redirectToWhatsApp();
  </script>
</body>
</html>
